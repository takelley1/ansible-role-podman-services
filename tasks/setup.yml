---

- name: SETUP | Ufw enabled and running
  systemd:
    name: ufw
    state: started
    enabled: true
    masked: false
  when: ansible_facts.os_family == "Debian"

- name: SETUP | Firewalld enabled and running
  systemd:
    name: firewalld
    state: started
    enabled: true
    masked: false
  when: ansible_facts.os_family == "RedHat"

- name: SETUP | Podman user exists
  ansible.builtin.user:
    name: "{{ podman_user }}"

- name: SETUP | Podman installed (Debian)
  block:
    - name: SETUP | Get release
      shell: lsb_release -rs
      changed_when: false
      register: release

    - name: SETUP | Podman repo GPG key present
      ansible.builtin.apt_key:
        url: >
          https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_{{ release.stdout }}/Release.key

    - name: SETUP | Podman repo present
      ansible.builtin.apt_repository:
        filename: podman-stable
        repo: >
          deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_{{ release.stdout }} /

    - name: SETUP | Podman installed
      ansible.builtin.apt:
        update_cache: true
        name:
          - podman
  when: ansible_facts.os_family == "Debian"

- name: SETUP | Podman installed (RedHat)
  ansible.builtin.dnf:
    name:
      - podman
      - python-podman-api
  when: ansible_facts.os_family == "RedHat"

- name: SETUP | SELinux configured
  block:
    - name: SETUP | Check for rule
      shell: semodule -l | grep -q permissive_container_t
      register: check
      changed_when: false

    - name: SETUP | Add rule
      shell: semanage permissive -a container_t
      when: check.rc != 0
  when: ansible_facts.os_family == "RedHat"
